
taha@HP-Probook:~/Documents/Projects/Aeroscraper/aeroscraper-contracts$ ANCHOR_PROVIDER_URL=https://devnet.helius-rpc.com/?api-key=e153d2eb-e16c-4b9d-a369-c418cfff8e13 ANCHOR_WALLET=~/.config/solana/id.json npx ts-mocha -p ./tsconfig.json -t 1000000 'tests/**/protocol-liquidation.ts'
(node:701323) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///home/taha/Documents/Projects/Aeroscraper/aeroscraper-contracts/tests/protocol-liquidation.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /home/taha/Documents/Projects/Aeroscraper/aeroscraper-contracts/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  Protocol Contract - Liquidation Tests

üöÄ Setting up Liquidation Tests for devnet...
üöÄ Setting up test environment for devnet...
‚úÖ Using existing stablecoin mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
‚úÖ Using existing devnet collateral mint from vault: Hygyfy8RBxLvoz5b3ffsg9PAvEkT3BJXXdTpVu6ftZYz
‚úÖ Oracle already initialized
‚úÖ Fees already initialized
‚úÖ Protocol already initialized
‚úÖ FeeAddress1 already funded: 10.900000013 SOL
‚úÖ FeeAddress2 already funded: 10.900000032 SOL
‚úÖ FeeAddress1 token account already exists: GqY4SbdRG4vudGatbLN4d6yfnXXPzPrHDJBKWbgonxQq
‚úÖ FeeAddress2 token account already exists: Hn5V9cYLmZDPwXQcp4vc6VMDzVatpBZBmmwNGXDNj6Cq
üìä Admin balance: 28.681399567 SOL
üìä Liquidator balance: 0.01 SOL
‚úÖ Liquidator already has sufficient balance
‚úÖ Liquidation test setup complete
    Test 4.1: Query Liquidatable Troves
üìã Querying liquidatable troves...
  Found 14 liquidatable trove(s) out of 57 total
  Trove owner: 7uaVocMoCPCCR6tfwXvhg6dE8TZ6UiVjxL5NDxnzrDcF, ICR: 44152867%
  Trove owner: 7Mx9GjN7xMhVLhMwJLKDt6QZZZMxc4tSqvDDbiff1NS1, ICR: 29435245%
  Trove owner: HU4Ju9Mo2WNo1HKCTaHXghDQNGeGoTLqVaAzYYQpw5ur, ICR: 14717622%
  Trove owner: Cm6dZEhTaKRu9FWwqm3sSsUT4Tp6H1g6a1ebbVSGRzys, ICR: 44152867%
  Trove owner: BGWywYvYFkMLbQZ9mb9oR8w6x8LUisdBc1zUj8BeLnW1, ICR: 44152867%
  Trove owner: 64QbRnuLeUXEP3t1yzj8RxwroBKmoEidYvoMKge9GzEr, ICR: 29435245%
  Trove owner: CGFpSafEqT2ztVWZL8dJSGhzsVxwc1urpNK9UgV7AunS, ICR: 29435245%
  Trove owner: 21AJoYVPj3TZbY2De3GfTVAtecsUHQ9oLUVoQNepssN5, ICR: 91054613%
  Trove owner: GBwe7hZor3Po53qycpwQiSamKcqM3rt2FyzSVroeiPLa, ICR: 44152867%
  Trove owner: BAYrNA95bLF4ktQCroxkW68L7C4rJfaDCiFGAnpPyHWq, ICR: 29435245%
  Trove owner: GwBQG3Ef7rWL6s7UAUCTM16ayi3JqaJNqgXgFWkUMWi2, ICR: 29435245%
  Trove owner: D6SXExNwDj8AjWF3wPbqiJcAsByPZEwZM3c6rFhirnzi, ICR: 29435245%
  Trove owner: 7YkW6FCB4yppgiaMAv2EWzRVnnF6Tx6bBQ7QSjse1JNY, ICR: 29435245%
  Trove owner: HCwVC9DU1fGwzfvTCb5wqqGBVHX5bnzHWvkUTvHNryXk, ICR: 29435245%
‚úÖ Liquidation query functional test passed
      ‚úî Should identify undercollateralized troves (87963ms)
    Test 4.2: Liquidate Single Undercollateralized Trove
      - Should liquidate trove when ICR falls below MCR
    Test 4.3: Liquidate Multiple Troves in Batch
üìã Testing batch liquidation...
  ‚úÖ Batch liquidation supports up to 50 troves
  ‚úÖ Remaining accounts pattern for scalability
  ‚úÖ liquidateTrovesHelper function structured for batch operations
‚úÖ Batch liquidation capability verified
      ‚úî Should liquidate multiple troves efficiently
    Single Trove Liquidation (liquidate_trove)
üìã Starting single trove liquidation (liquidate_trove) test...
  Found liquidatable trove: 7uaVocMoCPCCR6tfwXvhg6dE8TZ6UiVjxL5NDxnzrDcF, ICR: 44.152867%
targetDebt <BN: d2f13f7789f0000>
  Step 2.1: Adding collateral to user1's trove...
  ‚úÖ Added 1.0 SOL collateral to user1's trove
  Step 2.2: Borrowing aUSD from user1's trove...
      1) Should liquidate a single undercollateralized trove using named accounts
    Test 4.4: Liquidation with Stability Pool Coverage
üìã Testing stability pool coverage...
  ‚úÖ Debt burned from stability pool
  ‚úÖ Collateral distributed to stakers via S factor
  ‚úÖ P factor decreases (depletion tracking)
  ‚úÖ S factor increases (gains tracking)
‚úÖ Stability pool liquidation path structure verified
      ‚úî Should use stability pool to cover liquidated debt
    Test 4.5: Liquidation without Stability Pool
üìã Testing liquidation without stability pool...
  ‚ö†Ô∏è Note: Redistribution path not yet implemented in contract
  ‚úÖ Would fall back to redistribution mechanism if implemented
  ‚úÖ Would redistribute debt to other troves
‚úÖ Redistribution mechanism structure verified
      ‚úî Should handle liquidation when stability pool is empty
    Test 4.6: Collateral Distribution to Stakers
üìã Testing collateral distribution...
  ‚úÖ Distribution calculated via S factor = s_factor formula
  ‚úÖ S factor tracks cumulative gains per denom
  ‚úÖ Snapshot-based fair distribution (Product-Sum algorithm)
  ‚úÖ UserCollateralSnapshot PDA per user+denom tracks withdrawals
‚úÖ Distribution mechanism structure verified
      ‚úî Should distribute liquidated collateral proportionally
    Test 4.7: Debt Burning from Stability Pool
üìã Testing debt burning...
  ‚úÖ total_stake_amount decreases by liquidated debt
  ‚úÖ P factor updated (depletion: P_current < P_snapshot)
  ‚úÖ Epoch increments when P factor < 10^9
  ‚úÖ UserStakeAmount stores P snapshot for compounded stake
‚úÖ Debt burning mechanism structure verified
      ‚úî Should burn aUSD debt from stability pool
    Test 4.8: Withdraw Liquidation Gains
üìã Testing liquidation gains withdrawal...
  ‚úÖ StabilityPoolSnapshot PDA: BEwMweTRphLp3bDKtjsf8diZi9iQ1crY4E4jZ9ggQybK
  ‚úÖ withdraw_liquidation_gains instruction accepts collateral_denom
  ‚úÖ Calculates gains using S factor snapshot mechanism
  ‚úÖ Transfers collateral from protocol vault to user
  ‚úÖ Updates S snapshot to prevent double-spending
‚úÖ Liquidation gains withdrawal structure verified
      ‚úî Should withdraw collateral gains to stakers
    Test 4.9: ICR Calculation Accuracy
üìã Testing ICR calculation...
  ‚úÖ ICR = (collateral_value / debt_value) * 100
  ‚úÖ Uses real-time Pyth Network oracle prices via oracle helper
  ‚úÖ Minimum ICR = 115% for opening troves
  ‚úÖ Liquidation threshold = 110%
  ‚úÖ Multi-collateral support via denom parameter
‚úÖ ICR calculation structure verified
      ‚úî Should calculate Individual Collateral Ratio correctly
    Test 4.10: Sorted Troves Update After Liquidation
üìã Testing sorted troves update...
  ‚úÖ Off-chain sorting architecture used
  ‚úÖ Liquidated troves have debt = 0 (effectively closed)
  ‚úÖ LiquidityThreshold accounts remain for tracking
  ‚úÖ getProgramAccounts will exclude closed troves (debt = 0)
‚úÖ Off-chain sorted list integrity maintained
      ‚úî Should maintain sorted troves integrity after liquidation


  9 passing (3m)
  1 pending
  1 failing

  1) Protocol Contract - Liquidation Tests
       Single Trove Liquidation (liquidate_trove)
         Should liquidate a single undercollateralized trove using named accounts:
     Error: Account `userCollateralAccount` not provided.
      at /home/taha/Documents/Projects/Aeroscraper/aeroscraper-contracts/node_modules/@coral-xyz/anchor/src/program/common.ts:51:15
      at Array.forEach (<anonymous>)
      at validateAccounts (node_modules/@coral-xyz/anchor/src/program/common.ts:46:14)
      at ix (node_modules/@coral-xyz/anchor/src/program/namespace/instruction.ts:44:23)
      at txFn (node_modules/@coral-xyz/anchor/src/program/namespace/transaction.ts:24:14)
      at MethodsBuilder.rpc [as _rpcFn] (node_modules/@coral-xyz/anchor/src/program/namespace/rpc.ts:21:18)
      at MethodsBuilder.rpc (node_modules/@coral-xyz/anchor/src/program/namespace/methods.ts:434:17)
      at processTicksAndRejections (node:internal/process/task_queues:105:5)


