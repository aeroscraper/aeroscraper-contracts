
taha@HP-Probook:~/Documents/Projects/Aeroscraper/aeroscraper-contracts$ ANCHOR_PROVIDER_URL=https://devnet.helius-rpc.com/?api-key=e153d2eb-e16c-4b9d-a369-c418cfff8e13 ANCHOR_WALLET=~/.config/solana/id.json npx ts-mocha -p ./tsconfig.json -t 1000000 
'tests/**/protocol-liquidation.ts'
(node:685779) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///home/taha/Documents/Projects/Aeroscraper/aeroscraper-contracts/tests/protocol-liquidation.ts is not specified and it doesn't parse as CommonJS.
Reparsing as ES module because module syntax was detected. This incurs a performance overhead.
To eliminate this warning, add "type": "module" to /home/taha/Documents/Projects/Aeroscraper/aeroscraper-contracts/package.json.
(Use `node --trace-warnings ...` to show where the warning was created)


  Protocol Contract - Liquidation Tests

ğŸš€ Setting up Liquidation Tests for devnet...
ğŸš€ Setting up test environment for devnet...
âœ… Using existing stablecoin mint: GnasBgv2aBS97fUDGXGcseCQcXT9tGoKG9R49SDDyMMM
âœ… Using existing devnet collateral mint from vault: Hygyfy8RBxLvoz5b3ffsg9PAvEkT3BJXXdTpVu6ftZYz
âœ… Oracle already initialized
âœ… Fees already initialized
âœ… Protocol already initialized
âœ… FeeAddress1 already funded: 10.900000013 SOL
âœ… FeeAddress2 already funded: 10.900000032 SOL
âœ… FeeAddress1 token account already exists: GqY4SbdRG4vudGatbLN4d6yfnXXPzPrHDJBKWbgonxQq
âœ… FeeAddress2 token account already exists: Hn5V9cYLmZDPwXQcp4vc6VMDzVatpBZBmmwNGXDNj6Cq
ğŸ“Š Admin balance: 28.681399567 SOL
ğŸ“Š Liquidator balance: 0.01 SOL
âœ… Liquidator already has sufficient balance
âœ… Liquidation test setup complete
    Test 4.1: Query Liquidatable Troves
ğŸ“‹ Querying liquidatable troves...
  Found 15 liquidatable trove(s) out of 58 total
  Trove owner: 7uaVocMoCPCCR6tfwXvhg6dE8TZ6UiVjxL5NDxnzrDcF, ICR: 44152867%
  Trove owner: 7Mx9GjN7xMhVLhMwJLKDt6QZZZMxc4tSqvDDbiff1NS1, ICR: 29435245%
  Trove owner: HU4Ju9Mo2WNo1HKCTaHXghDQNGeGoTLqVaAzYYQpw5ur, ICR: 14717622%
  Trove owner: Cm6dZEhTaKRu9FWwqm3sSsUT4Tp6H1g6a1ebbVSGRzys, ICR: 44152867%
  Trove owner: BGWywYvYFkMLbQZ9mb9oR8w6x8LUisdBc1zUj8BeLnW1, ICR: 44152867%
  Trove owner: 64QbRnuLeUXEP3t1yzj8RxwroBKmoEidYvoMKge9GzEr, ICR: 29435245%
  Trove owner: CGFpSafEqT2ztVWZL8dJSGhzsVxwc1urpNK9UgV7AunS, ICR: 29435245%
  Trove owner: 21AJoYVPj3TZbY2De3GfTVAtecsUHQ9oLUVoQNepssN5, ICR: 91054613%
  Trove owner: GBwe7hZor3Po53qycpwQiSamKcqM3rt2FyzSVroeiPLa, ICR: 44152867%
  Trove owner: BAYrNA95bLF4ktQCroxkW68L7C4rJfaDCiFGAnpPyHWq, ICR: 29435245%
  Trove owner: GwBQG3Ef7rWL6s7UAUCTM16ayi3JqaJNqgXgFWkUMWi2, ICR: 29435245%
  Trove owner: D6SXExNwDj8AjWF3wPbqiJcAsByPZEwZM3c6rFhirnzi, ICR: 29435245%
  Trove owner: DZBYv8e9Qvd47mr7tXzPkwa7eW7rVRednrJn1ccM2NMY, ICR: 14717622%
  Trove owner: 7YkW6FCB4yppgiaMAv2EWzRVnnF6Tx6bBQ7QSjse1JNY, ICR: 29435245%
  Trove owner: HCwVC9DU1fGwzfvTCb5wqqGBVHX5bnzHWvkUTvHNryXk, ICR: 29435245%
âœ… Liquidation query functional test passed
      âœ” Should identify undercollateralized troves (52958ms)
    Test 4.2: Liquidate Single Undercollateralized Trove
      - Should liquidate trove when ICR falls below MCR
    Test 4.3: Liquidate Multiple Troves in Batch
ğŸ“‹ Testing batch liquidation...
  âœ… Batch liquidation supports up to 50 troves
  âœ… Remaining accounts pattern for scalability
  âœ… liquidateTrovesHelper function structured for batch operations
âœ… Batch liquidation capability verified
      âœ” Should liquidate multiple troves efficiently
    Single Trove Liquidation (liquidate_trove)
ğŸ“‹ Starting single trove liquidation (liquidate_trove) test...
  Found liquidatable trove: 7uaVocMoCPCCR6tfwXvhg6dE8TZ6UiVjxL5NDxnzrDcF, ICR: 44.152867%
      1) Should liquidate a single undercollateralized trove using named accounts
    Test 4.4: Liquidation with Stability Pool Coverage
ğŸ“‹ Testing stability pool coverage...
  âœ… Debt burned from stability pool
  âœ… Collateral distributed to stakers via S factor
  âœ… P factor decreases (depletion tracking)
  âœ… S factor increases (gains tracking)
âœ… Stability pool liquidation path structure verified
      âœ” Should use stability pool to cover liquidated debt
    Test 4.5: Liquidation without Stability Pool
ğŸ“‹ Testing liquidation without stability pool...
  âš ï¸ Note: Redistribution path not yet implemented in contract
  âœ… Would fall back to redistribution mechanism if implemented
  âœ… Would redistribute debt to other troves
âœ… Redistribution mechanism structure verified
      âœ” Should handle liquidation when stability pool is empty
    Test 4.6: Collateral Distribution to Stakers
ğŸ“‹ Testing collateral distribution...
  âœ… Distribution calculated via S factor = s_factor formula
  âœ… S factor tracks cumulative gains per denom
  âœ… Snapshot-based fair distribution (Product-Sum algorithm)
  âœ… UserCollateralSnapshot PDA per user+denom tracks withdrawals
âœ… Distribution mechanism structure verified
      âœ” Should distribute liquidated collateral proportionally
    Test 4.7: Debt Burning from Stability Pool
ğŸ“‹ Testing debt burning...
  âœ… total_stake_amount decreases by liquidated debt
  âœ… P factor updated (depletion: P_current < P_snapshot)
  âœ… Epoch increments when P factor < 10^9
  âœ… UserStakeAmount stores P snapshot for compounded stake
âœ… Debt burning mechanism structure verified
      âœ” Should burn aUSD debt from stability pool
    Test 4.8: Withdraw Liquidation Gains
ğŸ“‹ Testing liquidation gains withdrawal...
  âœ… StabilityPoolSnapshot PDA: BEwMweTRphLp3bDKtjsf8diZi9iQ1crY4E4jZ9ggQybK
  âœ… withdraw_liquidation_gains instruction accepts collateral_denom
  âœ… Calculates gains using S factor snapshot mechanism
  âœ… Transfers collateral from protocol vault to user
  âœ… Updates S snapshot to prevent double-spending
âœ… Liquidation gains withdrawal structure verified
      âœ” Should withdraw collateral gains to stakers
    Test 4.9: ICR Calculation Accuracy
ğŸ“‹ Testing ICR calculation...
  âœ… ICR = (collateral_value / debt_value) * 100
  âœ… Uses real-time Pyth Network oracle prices via oracle helper
  âœ… Minimum ICR = 115% for opening troves
  âœ… Liquidation threshold = 110%
  âœ… Multi-collateral support via denom parameter
âœ… ICR calculation structure verified
      âœ” Should calculate Individual Collateral Ratio correctly
    Test 4.10: Sorted Troves Update After Liquidation
ğŸ“‹ Testing sorted troves update...
  âœ… Off-chain sorting architecture used
  âœ… Liquidated troves have debt = 0 (effectively closed)
  âœ… LiquidityThreshold accounts remain for tracking
  âœ… getProgramAccounts will exclude closed troves (debt = 0)
âœ… Off-chain sorted list integrity maintained
      âœ” Should maintain sorted troves integrity after liquidation


  9 passing (2m)
  1 pending
  1 failing

  1) Protocol Contract - Liquidation Tests
       Single Trove Liquidation (liquidate_trove)
         Should liquidate a single undercollateralized trove using named accounts:
     Simulation failed. 
Message: Transaction simulation failed: Error processing Instruction 0: custom program error: 0x1. 
Logs: 
[
  "Program 8zG12srZdYaJPjWzCAJhwyxF7wWTz5spbmehxWpV5Q9M success",
  "Program log: Oracle CPI executed successfully for denom: SOL",
  "Program log: Price received: 13981741499 for SOL",
  "Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA invoke [2]",
  "Program log: Instruction: Burn",
  "Program log: Error: insufficient funds",
  "Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA consumed 4072 of 156991 compute units",
  "Program TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA failed: custom program error: 0x1",
  "Program 9sk8X11GWtZjzXWfkcLMRD6tmuhmiBKgMXsmx9bEh5YQ consumed 47081 of 200000 compute units",
  "Program 9sk8X11GWtZjzXWfkcLMRD6tmuhmiBKgMXsmx9bEh5YQ failed: custom program error: 0x1"
]. 
Catch the `SendTransactionError` and call `getLogs()` on it for full details.
  



taha@HP-Probook:~/Documents/Projects/Aeroscraper/aeroscraper-contracts$ 